Block library development
-------------------------

Blocks are defined in a script element with id "ui.json" in index-svg.html. The syntax of the script element is JSON. The appearance of blocks is defined by SVG elements specified by URI strings with syntax "filename#id", where "filename" is the id of a script element in index-svg.html which contains a complete svg file, and "id" is the svg element id in that file.

Here are fragments of index-svg.html which illustrate the definition of the block "button". Property "main" contains the URI of the svg element which is drawn for the button block. The filename part, "blocks.svg", refers to the script element which contains the svg the element belongs to; and the id part, "Ev_Buttons", is the element id in that svg.

<script type="application/json" id="ui.json">
...
"blocks": [
	...
	{
		"name": "button",
		"main": "blocks.svg#Ev_Buttons"
	}
	...
]
...
</script>

<script type="image/svg+xml" id="blocks.svg">
...
<g id="Ev_Buttons">
...
</g>
...
</script>

In json, block contain the following properties:

- "name" (string, required): the block name, which should match VPL1 if possible.

- "type" (string, required): one of "event", "state", "action", or "comment", which defines where the block is displayed (left for "event" or "state", right for "action" or "comment") and how it is used.

- "modes" (array of strings, possibly empty, required): in which VPL mode the block is displayed. Contains "basic" if displayed in basic mode, "advanced" if displayed in advanced mode. This defines only the default block usage; customization can override it.

- "svg" (array of objects, at least one element, required): list of the parts defining the block appearance including buttons, sliders, etc. Each part is described by an object with the following properties (** only "uri" is implemented now **):

	- "uri" (string, required): uri of the svg element
	- "scale" (number, optional, default: 1): scale at which the element is displayed
	- "dx" (number, optional, default: 0): horizontal displacement
	- "dy" (number, optional, default: 0): vertical displacement

- "defaultParameters" (array of number, boolean or string values, optional): default values of the block parameters which define the state, in this order, of buttons (one value per button), radiobuttons (a single values for all radiobuttons), sliders (one value per slider), rotating controls (one value per control).

- "buttons" (array of objects, optional): button definitions. Each button is described by an object with the following properties:

	- "id" (string, required): id of the svg element corresponding to the button. It should be contained in the element identified by "main".
	- "val" (array of numbers, booleans or strings, required): possible values for the button state. Each click toggles to the next value.
 	- "st" (array of strings): style strings applied to svg elements when the corresponding value in val is active. Each style is defined by a fill and/or a stroke color, with the syntax "fill:color;stroke:color", or fill/stroke swapped, or one of them skipped without semicolon.

- "radiobuttons" (array of objects, optional): radio button definitions (exclusive buttons). Each button is described by an object with the following properties:

	- "id" (string, required): id of the svg element corresponding to the button. It should be contained in the element identified by "main".
	- "val" (number, boolean or string, required): value for the set of radio buttons.
 	- "st" (array of strings): style strings applied to svg elements when the corresponding value in val is active. Each style is defined by a fill and/or a stroke color, with the syntax "fill:color;stroke:color", or fill/stroke swapped, or one of them skipped without semicolon.

- "sliders" (array of objects, optional): slider definitions. Each slider is described by an object with the following properties:

	- "id" (string, required): id of the svg element corresponding to the slider, including the thumb. If the element's height is larger than the element's width, the slider is vertical, else it's horizontal.
	- "thumbId" (string, required): id of the svg element corresponding to the thumb in the slider (the part which can be moved).
	- "min" (number, required): minimum value, stored in the block parameters.	- "max" (number, required): maximum value, stored in the block parameters.

- "rotating" (array of objects, optional): rotating control definitions. Each control is described by an object with the following properties:

	- "id" (string, required): id of the svg element corresponding to the slider, including the thumb. If the element's height is larger than the element's width, the slider is vertical, else it's horizontal.
	- "centerId" (string, required): id of the svg element whose center is the center of rotation.
	- "thumbId" (string, required): id of the svg element corresponding to the control part which can be moved.

- "diffwheelmotion" (object, optional): robot with differential wheel motion. The robot, seen from above, is defined by a svg element, with wheel axis on the x axis and positive motion up. Wheel motion is specified with two sliders which should be defined with "sliders". Contains the following properties:

	- "id" (string, required): id of the svg element corresponding to the robot.
	- "dx" (number, optional): relative horizontal adjustment of the right wheel position (left wheel is moved symmetrically).
	- "dy" (number, optional): relative vertical adjustment of the wheels.
	- "adjscale" (number, optional): scale adjustment for the traces; 1 (default) means that the wheels are at the svg element boundaries, <1 that they are inside the svg element boundaries.
	- "color" (string, optional): trace color as a css color string (default: "black")
	- "linewidth" (number, optional): relative trace width. 1 (default) is the default line width of the block.

- "aseba" (object, optional): code fragments to generate Aseba language source code. Code fragments contain Aseba source code. Except for "clause" and "clauseAnd" which contain expression fragments, they can contain muliple lines, comments, empty lines, terminated by linefeeds ("\n"). Backticks mark JavaScript expressions which are evaluated to substitute block parameters; variable whose name is a dollar character contains the block parameters, and variable "i" contains the parameter index in "clauseAnd" fragments. The object contains the following properties:
	- "initVarDecl" (array of strings, optional): code fragments for (global) variable declarations. Identical fragments (after backtick-expressions evaluation) are output only once.
	- "initCodeDecl" (array of strings, optional): code fragments for subroutine declarations. Identical fragments (after backtick-expressions evaluation) are output only once.
	- "initCodeExec" (array of strings, optional): code fragments for initialization. Identical fragments (after backtick-expressions evaluation) are output only once.
	- "sectionBegin" (string, optional, event block): beginning of a section (typically an onevent block). Identical sections are collected and a single sectionBegin and sectionEnd are output.
	- "sectionEnd" (string, optional, event block): end of a section (typically unused for Aseba code).
	- "sectionPriority" (number, optional, event block): section priority
	- "clauseInit" (string, optional, event block): code fragments for clause initialization. Identical fragments in the same section (after backtick-expressions evaluation) are output only once after "sectionBegin". Used to initialize temporary values used in clauses.
	- "clause" (string, optional, event block): clause expression (condition) used in "when" Aseba statement for the whole block.
	- "clauseAnd" (string, optional, event block): clause subsexpression. "clause" and "clauseAnd" cannot be used in the same block. "clauseAnd" expressions are produced for each parameter; the whole clause is obtained by joining "clauseAnd" expressions with the "and" operator.
	- "statement" (string, required, action block): code fragment for action.

- "l2" (object, optional): code fragments to generate L2 language source code. Same properties as "aseba".
