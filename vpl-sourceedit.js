/*
	Copyright 2018 ECOLE POLYTECHNIQUE FEDERALE DE LAUSANNE,
	Miniature Mobile Robots group, Switzerland
	Author: Yves Piguet
	For internal use only
*/

/** Source editor for code generated by VPL
	@constructor
	@param {boolean} noVPL true if only text editor without VPL
	@param {string=} language
	@param {?A3a.vpl.RunGlue=} runGlue
*/
A3a.vpl.VPLSourceEditor = function (noVPL, language, runGlue) {
	this.noVPL = noVPL;
	this.language = language || A3a.vpl.defaultLanguage;
	this.runGlue = runGlue || null;
	this.code0 = "";	// from VPL, to restore when VPL lock is set
	this.isLockedWithVPL = true;
	this.textEditor = new A3a.vpl.TextEditor("editor", "editor-lines");
	this.textEditor.setReadOnly(this.isLockedWithVPL);
	this.textEditor.onBreakpointChanged = function (bp) {
		window["vplBreakpointsFunction"] && window["vplBreakpointsFunction"](bp);
	};

	var canvasElement = document.getElementById("editorTBCanvas");
	this.tbCanvas = new A3a.vpl.Canvas(canvasElement);

	var self = this;

	// initial canvas resize
	this.resize();

	// editor control update
	document.getElementById("editor").addEventListener("input",
		function () {
			self.toolbarRender();
		},
		false);
	// editor tab key
	document.getElementById("editor").addEventListener("keydown", function (e) {
		if (e.keyCode === 9) {
			// prevent loss of focus in textarea
			e.preventDefault();
			e.cancelBubbles = true;
			var textarea = document.getElementById("editor");
			var text = textarea.value;
			var start = this.selectionStart, end = this.selectionEnd;
			text = text.slice(0, start) + "\t" + text.slice(end);
			self.textEditor.setContent(text);
			this.selectionStart = this.selectionEnd = start + 1;
			return false;
		}
		// normal behavior
		return true;
	}, false);

	this.toolbarRender();
};

/** Set the code generated from VPL
	@param {string} code
	@return {void}
*/
A3a.vpl.VPLSourceEditor.prototype.setCode = function (code) {
	this.code0 = code;
	this.textEditor.setContent(code);
};

/** Get the current code
	@return {string}
*/
A3a.vpl.VPLSourceEditor.prototype.getCode = function () {
	return document.getElementById("editor").value.trim();
};

/** Calculate the toolbar height
	@return {number}
*/
A3a.vpl.VPLSourceEditor.prototype.srcToolbarHeight = function () {
	var dims = this.tbCanvas.dims;
	return dims.controlSize + 2 * dims.interBlockSpace;
};

/** Render toolbar for source code editor
	@return {void}
*/
A3a.vpl.VPLSourceEditor.prototype.toolbarRender = function () {
	// start with an empty canvas
	this.tbCanvas.clearItems();

	// top controls
	var canvasSize = this.tbCanvas.getSize();

	// top controls
	var controlBar = new A3a.vpl.ControlBar(this.tbCanvas);

	var self = this;

	// new
	controlBar.addControl(
		// draw
		function (ctx, item, dx, dy) {
			ctx.fillStyle = "navy";
			ctx.fillRect(item.x + dx, item.y + dy,
				self.tbCanvas.dims.controlSize, self.tbCanvas.dims.controlSize);
			ctx.beginPath();
			ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.25,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.25,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.8);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.75,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.8);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.75,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.3);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.65,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
			ctx.closePath();
			ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.65,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.65,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.3);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.75,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.3);
			ctx.strokeStyle = "white";
			ctx.lineWidth = self.tbCanvas.dims.blockLineWidth;
			ctx.stroke();
		},
		// mousedown
		function (data, x, y, ev) {
			self.textEditor.setContent("");
			return 0;
		},
		// doDrop
		null,
		// canDrop
		null);

	// save
	var isEditorEmpty = this.getCode().length === 0;
	controlBar.addControl(
		// draw
		function (ctx, item, dx, dy) {
			ctx.fillStyle = "navy";
			ctx.fillRect(item.x + dx, item.y + dy,
				self.tbCanvas.dims.controlSize, self.tbCanvas.dims.controlSize);
			ctx.beginPath();
			ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.25,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.25,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.7);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.67,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.7);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.67,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.27);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.6,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
			ctx.closePath();
			ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.6,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.6,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.27);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.67,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.27);
			ctx.strokeStyle = isEditorEmpty ? "#777" : "white";
			ctx.lineWidth = self.tbCanvas.dims.blockLineWidth;
			ctx.stroke();
			ctx.lineWidth = 2 * self.tbCanvas.dims.blockLineWidth;
			ctx.beginPath();
			ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.8,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.5);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.8,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.8);
			ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.7,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.7);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.8,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.8);
			ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.9,
				item.y + dy + self.tbCanvas.dims.controlSize * 0.7);
			ctx.stroke();
		},
		// mousedown
		function (data, x, y, ev) {
			if (!isEditorEmpty) {
				var src = self.getCode();
				var aesl = A3a.vpl.Program.toAESLFile(src);
				A3a.vpl.Program.downloadText(aesl, "code.aesl");
			}
			return 0;
		},
		// doDrop
		null,
		// canDrop
		null);

	// vpl
	if (!this.noVPL) {
		// switch to VPL
		controlBar.addControl(
			// draw
			function (ctx, item, dx, dy) {
				var enabled = self.getCode() === self.code0.trim();
				ctx.save();
				ctx.fillStyle = "navy";
				ctx.fillRect(item.x + dx, item.y + dy,
					self.tbCanvas.dims.controlSize, self.tbCanvas.dims.controlSize);
				ctx.beginPath();
				ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.25,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.25,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.8);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.75,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.8);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.75,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.3);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.65,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
				ctx.closePath();
				ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.65,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.2);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.65,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.3);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.75,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.3);
				ctx.strokeStyle = enabled ? "white" : "#777";
				ctx.lineWidth = self.tbCanvas.dims.blockLineWidth;
				ctx.stroke();
				ctx.fillStyle = "#99a";
				for (var y = 0.15; y < 0.6; y += 0.15) {
					ctx.fillRect(item.x + dx + self.tbCanvas.dims.controlSize * 0.3,
						item.y + dy + self.tbCanvas.dims.controlSize * (0.2 + y),
						self.tbCanvas.dims.controlSize * 0.4,
						self.tbCanvas.dims.controlSize * 0.10);
				}
				ctx.restore();
			},
			// mousedown
			function (data, x, y, ev) {
				var enabled = self.getCode() === self.code0.trim();
				if (enabled) {
					window["vplProgram"].setView("vpl");
				}
				return 0;
			},
			// doDrop
			null,
			// canDrop
			null);

		// locked with VPL
		controlBar.addControl(
			// draw
			function (ctx, item, dx, dy) {
				ctx.save();
	            ctx.fillStyle = self.isLockedWithVPL ? "#06f" : "navy";
				ctx.fillRect(item.x + dx, item.y + dy,
					self.tbCanvas.dims.controlSize, self.tbCanvas.dims.controlSize);
				ctx.strokeStyle = "white";
				ctx.lineWidth = self.tbCanvas.dims.blockLineWidth;
				ctx.fillStyle = self.isLockedWithVPL ? "#ddf" : "#99a";
				for (var y = 0.15; y < 0.6; y += 0.15) {
					ctx.fillRect(item.x + dx + self.tbCanvas.dims.controlSize * 0.15,
						item.y + dy + self.tbCanvas.dims.controlSize * (0 + y),
						self.tbCanvas.dims.controlSize * 0.4,
						self.tbCanvas.dims.controlSize * 0.10);
				}
				A3a.vpl.Canvas.lock(ctx,
					item.x + dx + self.tbCanvas.dims.controlSize * 0.77,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.36,
					self.tbCanvas.dims.controlSize * 0.06,
					"white",
					!self.isLockedWithVPL);
	            ctx.fillStyle = self.isLockedWithVPL ? "white" : "#44a";
	            ctx.fillRect(item.x + dx + self.tbCanvas.dims.controlSize * 0.1,
	                item.y + dy + self.tbCanvas.dims.controlSize * 0.8,
	                self.tbCanvas.dims.controlSize * 0.8,
	                self.tbCanvas.dims.controlSize * 0.1);
				ctx.restore();
			},
			// mousedown
			function (data, x, y, ev) {
				self.lockWithVPL(!self.isLockedWithVPL);
				self.tbCanvas.redraw();
				return 0;
			},
			// doDrop
			null,
			// canDrop
			null);
	}

	controlBar.addStretch();

	if (this.runGlue) {
		controlBar.addControl(
			// draw
			function (ctx, item, dx, dy) {
				ctx.fillStyle = "navy";
				ctx.fillRect(item.x + dx, item.y + dy,
					self.tbCanvas.dims.controlSize, self.tbCanvas.dims.controlSize);
				ctx.beginPath();
				ctx.moveTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.3,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.25);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.3,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.75);
				ctx.lineTo(item.x + dx + self.tbCanvas.dims.controlSize * 0.8,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.5);
				ctx.closePath();
				ctx.fillStyle = self.runGlue.isEnabled(self.language) ? "white" : "#777";
				ctx.fill();
			},
			// mousedown
			function (data, x, y, ev) {
				var code = self.getCode();
				self.runGlue.run(code, self.language);
				return 0;
			},
			// doDrop
			null,
			// canDrop
			null);

		controlBar.addControl(
			// draw
			function (ctx, item, dx, dy) {
				ctx.fillStyle = "navy";
				ctx.fillRect(item.x + dx, item.y + dy,
					self.tbCanvas.dims.controlSize, self.tbCanvas.dims.controlSize);
				ctx.fillStyle = self.runGlue.isEnabled(self.language) ? "white" : "#777";
				ctx.fillRect(item.x + dx + self.tbCanvas.dims.controlSize * 0.28,
					item.y + dy + self.tbCanvas.dims.controlSize * 0.28,
					self.tbCanvas.dims.controlSize * 0.44, self.tbCanvas.dims.controlSize * 0.44);
				ctx.fill();
			},
			// mousedown
			function (data, x, y, ev) {
				self.runGlue.stop(self.language);
				return 0;
			},
			// doDrop
			null,
			// canDrop
			null);

		if (window["vplSim"]) {
			controlBar.addSpace();

			controlBar.addControl(
				// draw
				function (ctx, item, dx, dy) {
					ctx.fillStyle = "navy";
					ctx.fillRect(item.x + dx, item.y + dy,
						self.tbCanvas.dims.controlSize, self.tbCanvas.dims.controlSize);
					ctx.save();
					ctx.translate(item.x + dx + self.tbCanvas.dims.controlSize / 2, item.y + dy + self.tbCanvas.dims.controlSize * 0.35);
					ctx.scale(0.4, 0.4);
					ctx.rotate(0.2);
					ctx.beginPath();
					// middle rear
					ctx.moveTo(0, 0.5 * self.tbCanvas.dims.controlSize);
					// right side
					ctx.lineTo(0.5 * self.tbCanvas.dims.controlSize, 0.5 * self.tbCanvas.dims.controlSize);
					ctx.lineTo(0.5 * self.tbCanvas.dims.controlSize, -0.25 * self.tbCanvas.dims.controlSize);
					ctx.bezierCurveTo(0.3 * self.tbCanvas.dims.controlSize, -0.5 * self.tbCanvas.dims.controlSize,
						self.tbCanvas.dims.controlSize * 0.02, -0.5 * self.tbCanvas.dims.controlSize,
						0, -0.5 * self.tbCanvas.dims.controlSize);
					// left side
					ctx.lineTo(0, -0.5 * self.tbCanvas.dims.controlSize);
					ctx.bezierCurveTo(-0.02 * self.tbCanvas.dims.controlSize, -0.5 * self.tbCanvas.dims.controlSize,
						-0.3 * self.tbCanvas.dims.controlSize, -0.5 * self.tbCanvas.dims.controlSize,
						-0.5 * self.tbCanvas.dims.controlSize, -0.25 * self.tbCanvas.dims.controlSize);
					ctx.lineTo(-0.5 * self.tbCanvas.dims.controlSize, 0.5 * self.tbCanvas.dims.controlSize);
					ctx.closePath();
					ctx.fillStyle = "white";
					ctx.fill();
					ctx.beginPath();
					ctx.arc(self.tbCanvas.dims.controlSize, 0.5 * self.tbCanvas.dims.controlSize, 1.4 * self.tbCanvas.dims.controlSize,
						-3.2, -3.8, true);
					ctx.strokeStyle = "#999";
					ctx.lineWidth = 0.2 * self.tbCanvas.dims.controlSize;
					ctx.stroke();
					ctx.beginPath();
					ctx.arc(self.tbCanvas.dims.controlSize, 0.5 * self.tbCanvas.dims.controlSize, 0.6 * self.tbCanvas.dims.controlSize,
						-3.3, -3.8, true);
					ctx.stroke();

					ctx.restore();
				},
				// mousedown
				function (data, x, y, ev) {
					window["vplProgram"].setView("sim");
					return 0;
				},
				// doDrop
				null,
				// canDrop
				null);
		}

		controlBar.addStretch();
	}

	controlBar.calcLayout(this.tbCanvas.dims.margin, canvasSize.width - this.tbCanvas.dims.margin,
		this.tbCanvas.dims.controlSize,
		this.tbCanvas.dims.interBlockSpace, 2 * this.tbCanvas.dims.interBlockSpace);
	controlBar.addToCanvas();
	this.tbCanvas.redraw();
};

/** Change the lock status
	@param {boolean} b
	@return {void}
*/
A3a.vpl.VPLSourceEditor.prototype.lockWithVPL = function (b) {
	this.isLockedWithVPL = b;
	if (b) {
		this.textEditor.setContent(this.code0);
	}
	this.textEditor.setReadOnly(b);
};

/** Resize the source code editor
	@return {void}
*/
A3a.vpl.VPLSourceEditor.prototype.resize = function () {
	var width = window.innerWidth;
	var height = window.innerHeight;
	if (window["vplDisableResize"]) {
		var bnd = this.tbCanvas.canvas.getBoundingClientRect();
		width = bnd.width;
		height = bnd.height;
	}

	this.tbCanvas.dims = this.tbCanvas.dims;
	this.tbCanvas.resize(width, this.srcToolbarHeight());
	this.tbCanvas.canvas.style.height = this.tbCanvas.height + "px";
	this.toolbarRender();
	var editor = document.getElementById("editor");
	editor.parentElement.style.height = (window.innerHeight - this.tbCanvas.canvas.getBoundingClientRect().height) + "px";
};

/** Set the focus to the editor
	@return {void}
*/
A3a.vpl.VPLSourceEditor.prototype.focus = function () {
	document.getElementById("editor").focus();
	this.tbCanvas.redraw();	// update toolbar state
};
